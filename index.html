<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventari</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            font-size: 16px;
        }

        input, button {
            margin: 5px 0;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
            font-size: 14px;
        }

        th {
            background-color: #f4f4f4;
        }

        .scrollable {
            max-height: 300px;
            overflow-y: auto;
            display: block;
        }

        .error-message {
            color: red;
            font-weight: bold;
            padding: 10px;
            background-color: #ffe6e6;
            border: 1px solid red;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            color: green;
            font-weight: bold;
            padding: 10px;
            background-color: #e6ffe6;
            border: 1px solid green;
            margin: 10px 0;
            display: none;
        }

        @media (max-width: 600px) {
            body {
                margin: 5px;
                font-size: 14px;
            }

            h1, h2, h3 {
                font-size: 1.5em;
                margin: 10px 0;
            }

            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                margin-bottom: 20px;
            }

            th, td {
                padding: 8px;
                font-size: 12px;
                min-width: 120px;
            }

            input, button {
                padding: 8px;
                font-size: 14px;
            }

            .scrollable {
                max-height: 200px;
            }

            button {
                width: auto;
                margin: 10px auto;
            }

            h3 {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>

<h1>Inventari</h1>

<div id="errorMessage" class="error-message"></div>
<div id="successMessage" class="success-message"></div>

<h2>Produktet</h2>
<div class="scrollable">
    <table>
        <thead>
            <tr>
                <th>Produktet</th>
                <th>Cmimi (per cope)</th>
                <th>Sasia</th>
                <th>Kostoja Totale</th>
                <th>Turni 1</th>
                <th>Turni 2</th>
                <th>Totali Final</th>
            </tr>
        </thead>
        <tbody id="productTable"></tbody>
    </table>
</div>

<h3>Kostoja Totale Ditore: L <span id="dailyTotal">0.00</span></h3>
<button onclick="saveRecord()">Ruaji të dhënat</button>

<h2>Lista e Ruajtur</h2>
<div class="scrollable">
    <table>
        <thead>
            <tr>
                <th>Data</th>
                <th>Produkte</th>
                <th>Çmimet</th>
                <th>Sasitë</th>
                <th>Kostoja Totale</th>
                <th>Turni 1</th>
                <th>Turni 2</th>
                <th>Totali Final</th>
                <th>Gjithsej kostoTotale</th>
                <th>Gjithsej Totali Final</th>
                <th>Xhiro ditore</th>
                <th>Veprimi</th>
            </tr>
        </thead>
        <tbody id="recordTable"></tbody>
    </table>
</div>

<script>
    const products = [
        { product: "Ekmek", price: 1.5 },
        { product: "Torte", price: 12.000 },
        { product: "Zupa", price: 1.000 },
        { product: "Trilece", price: 5.000 },
        { product: "Kausha", price: 10.000 },
        { product: "Peta", price: 1.000 },
        { product: "Rulon", price: 10.000 },
        { product: "Pastashu", price: 1.000 },
        { product: "Kompeka", price: 10.000 },
        { product: "Bakllava", price: 10.000 },
        { product: "Torte racion", price: 1.5 },
        { product: "Porcione", price: 12.000 },
        { product: "Tolluma", price: 1.5 },
        { product: "Buke franxholla", price: 12.000 },
        { product: "Franxholla", price: 6.000 },
        { product: "Buke me topa", price: 10.000 },
        { product: "Buke masive", price: 1.5 },
        { product: "Buke me fara", price: 12.000 },
        { product: "Buke fshati", price: 10.000 },
        { product: "Buke e rrumbullaket", price: 1.5 },
        { product: "Buke e gjate", price: 12.000 },
        { product: "Kulac", price: 6.000 },
        { product: "Buke me ullinj", price: 12.000 },
        { product: "Buke e verdhe", price: 6.000 },
        { product: "Buke integrale", price: 10.000 },
        { product: "Buke Bogeti", price: 1.5 },
        { product: "Buke misri", price: 12.000 },
        { product: "Buke thekre", price: 10.000 },
        { product: "Pite", price: 1.5 },
        { product: "Simite", price: 12.000 },
        { product: "Sanduic", price: 6.000 },
        { product: "Sanduic me fara", price: 12.000 },
        { product: "Sanduic i verdhe", price: 6.000 },
        { product: "Briosh", price: 10.000 },
        { product: "Donat", price: 1.5 },
        { product: "Byrek", price: 5.00 },
        { product: "Pica", price: 1.5 },
        { product: "Kos 380gr", price: 12.000 },
        { product: "Kos bidon", price: 6.000 },
        { product: "Kos i madh", price: 12.000 },
        { product: "Kos 200", price: 6.000 },
        { product: "Dhalle bidon", price: 10.000 },
        { product: "Salce kosi 900gr", price: 10.000 },
        { product: "Boze", price: 6.000 },
        { product: "Uje Bukanik 7kg", price: 1.5 }
    ];

    let db;
    
    // Show error message
    function showError(message) {
        const errorElement = document.getElementById("errorMessage");
        errorElement.textContent = message;
        errorElement.style.display = "block";
        setTimeout(() => {
            errorElement.style.display = "none";
        }, 5000);
    }
    
    // Show success message
    function showSuccess(message) {
        const successElement = document.getElementById("successMessage");
        successElement.textContent = message;
        successElement.style.display = "block";
        setTimeout(() => {
            successElement.style.display = "none";
        }, 3000);
    }

    function openDB() {
        return new Promise((resolve, reject) => {
            // Check if IndexedDB is supported
            if (!window.indexedDB) {
                showError("Your browser doesn't support IndexedDB. Please use a modern browser.");
                reject("IndexedDB not supported");
                return;
            }
            
            const request = indexedDB.open("InventoryDB", 1);

            request.onupgradeneeded = function(event) {
                db = event.target.result;
                if (!db.objectStoreNames.contains('records')) {
                    db.createObjectStore('records', { keyPath: 'id', autoIncrement: true });
                }
            };

            request.onsuccess = function(event) {
                db = event.target.result;
                resolve(db);
            };

            request.onerror = function(event) {
                showError("Error opening database: " + event.target.error);
                reject("Error opening DB");
            };
        });
    }

    function saveRecordToDB(record) {
        return new Promise((resolve, reject) => {
            if (!db) {
                showError("Database not initialized");
                reject("Database not initialized");
                return;
            }
            
            try {
                const transaction = db.transaction(['records'], 'readwrite');
                const store = transaction.objectStore('records');
                const request = store.add(record);

                request.onsuccess = function(event) {
                    resolve(event.target.result); // Return the new record ID
                };

                request.onerror = function(event) {
                    showError("Error saving record: " + event.target.error);
                    reject("Error saving record");
                };
            } catch (error) {
                showError("Error in transaction: " + error.message);
                reject(error);
            }
        });
    }

    function loadRecordsFromDB() {
        return new Promise((resolve, reject) => {
            if (!db) {
                showError("Database not initialized");
                reject("Database not initialized");
                return [];
            }
            
            try {
                const transaction = db.transaction(['records'], 'readonly');
                const store = transaction.objectStore('records');
                const request = store.getAll();

                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    showError("Error loading records: " + event.target.error);
                    reject("Error loading records");
                };
            } catch (error) {
                showError("Error in transaction: " + error.message);
                reject(error);
                return [];
            }
        });
    }

    function deleteRecordFromDB(id) {
        return new Promise((resolve, reject) => {
            if (!db) {
                showError("Database not initialized");
                reject("Database not initialized");
                return;
            }
            
            try {
                const transaction = db.transaction(['records'], 'readwrite');
                const store = transaction.objectStore('records');
                const request = store.delete(Number(id));

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    showError("Error deleting record: " + event.target.error);
                    reject("Error deleting record");
                };
            } catch (error) {
                showError("Error in transaction: " + error.message);
                reject(error);
            }
        });
    }

    function renderProductTable() {
        const productTable = document.getElementById("productTable");
        productTable.innerHTML = "";

        products.forEach((product, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${product.product}</td>
                <td>${product.price.toFixed(2)}</td>
                <td><input type="number" id="quantity-${index}" value="0" min="0" oninput="updateDailyTotal()"></td>
                <td id="total-${index}">0.00</td>
                <td><input type="number" id="part1-${index}" value="0" min="0" oninput="updateDailyTotal()"></td>
                <td><input type="number" id="part2-${index}" value="0" min="0" oninput="updateDailyTotal()"></td>
                <td id="finalTotal-${index}">0.00</td>
            `;
            productTable.appendChild(row);
        });

        for (let i = 0; i < 10; i++) {
            const emptyRow = document.createElement("tr");
            emptyRow.innerHTML = `
                <td><input type="text" id="product-extra-${i}" placeholder="Product name"></td>
                <td><input type="number" id="price-extra-${i}" placeholder="Price" step="0.01" min="0" oninput="updateDailyTotal()"></td>
                <td><input type="number" id="quantity-extra-${i}" value="0" min="0" oninput="updateDailyTotal()"></td>
                <td id="total-extra-${i}">0.00</td>
                <td><input type="number" id="part1-extra-${i}" value="0" min="0" oninput="updateDailyTotal()"></td>
                <td><input type="number" id="part2-extra-${i}" value="0" min="0" oninput="updateDailyTotal()"></td>
                <td id="finalTotal-extra-${i}">0.00</td>
            `;
            productTable.appendChild(emptyRow);
        }
    }

    function updateDailyTotal() {
        let dailyTotal = 0;

        // Calculate for predefined products
        products.forEach((product, index) => {
            const quantity = parseFloat(document.getElementById(`quantity-${index}`).value) || 0;
            const part1 = parseFloat(document.getElementById(`part1-${index}`).value) || 0;
            const part2 = parseFloat(document.getElementById(`part2-${index}`).value) || 0;

            const totalCost = quantity * product.price;
            const finalTotal = totalCost - (part1 * product.price) - (part2 * product.price);

            document.getElementById(`total-${index}`).innerText = totalCost.toFixed(2);
            document.getElementById(`finalTotal-${index}`).innerText = finalTotal.toFixed(2);

            dailyTotal += finalTotal;
        });

        // Calculate for custom products
        for (let i = 0; i < 10; i++) {
            const productName = document.getElementById(`product-extra-${i}`).value.trim();
            const price = parseFloat(document.getElementById(`price-extra-${i}`).value) || 0;
            const quantity = parseFloat(document.getElementById(`quantity-extra-${i}`).value) || 0;
            const part1 = parseFloat(document.getElementById(`part1-extra-${i}`).value) || 0;
            const part2 = parseFloat(document.getElementById(`part2-extra-${i}`).value) || 0;

            if (price > 0 && quantity > 0) {
                const totalCost = price * quantity;
                const finalTotal = totalCost - (part1 * price) - (part2 * price);

                document.getElementById(`total-extra-${i}`).innerText = totalCost.toFixed(2);
                document.getElementById(`finalTotal-extra-${i}`).innerText = finalTotal.toFixed(2);

                dailyTotal += finalTotal;
            } else {
                document.getElementById(`total-extra-${i}`).innerText = "0.00";
                document.getElementById(`finalTotal-extra-${i}`).innerText = "0.00";
            }
        }

        document.getElementById("dailyTotal").innerText = dailyTotal.toFixed(2);
    }

    async function saveRecord() {
        try {
            let sumTotalCost = 0;
            let sumFinalTotal = 0;
            let allProducts = [];

            // Process predefined products
            products.forEach((product, index) => {
                const quantity = parseFloat(document.getElementById(`quantity-${index}`).value) || 0;
                if (quantity > 0) {
                    const part1 = parseFloat(document.getElementById(`part1-${index}`).value) || 0;
                    const part2 = parseFloat(document.getElementById(`part2-${index}`).value) || 0;

                    const totalCost = quantity * product.price;
                    const finalTotal = totalCost - (part1 * product.price) - (part2 * product.price);

                    sumTotalCost += totalCost;
                    sumFinalTotal += finalTotal;

                    allProducts.push({
                        product: product.product,
                        price: product.price,
                        quantity: quantity,
                        part1: part1,
                        part2: part2,
                        totalCost: totalCost.toFixed(2),
                        finalTotal: finalTotal.toFixed(2)
                    });
                }
            });

            // Process custom products
            for (let i = 0; i < 10; i++) {
                const productName = document.getElementById(`product-extra-${i}`).value.trim();
                const price = parseFloat(document.getElementById(`price-extra-${i}`).value) || 0;
                const quantity = parseFloat(document.getElementById(`quantity-extra-${i}`).value) || 0;
                
                if (productName && price > 0 && quantity > 0) {
                    const part1 = parseFloat(document.getElementById(`part1-extra-${i}`).value) || 0;
                    const part2 = parseFloat(document.getElementById(`part2-extra-${i}`).value) || 0;

                    const totalCost = price * quantity;
                    const finalTotal = totalCost - (part1 * price) - (part2 * price);

                    sumTotalCost += totalCost;
                    sumFinalTotal += finalTotal;

                    allProducts.push({
                        product: productName,
                        price: price,
                        quantity: quantity,
                        part1: part1,
                        part2: part2,
                        totalCost: totalCost.toFixed(2),
                        finalTotal: finalTotal.toFixed(2)
                    });
                }
            }

            // Check if there are products to save
            if (allProducts.length === 0) {
                showError("No products to save. Please add quantities.");
                return;
            }

            const record = {
                date: new Date().toLocaleString(),
                products: allProducts,
                sumTotalCost: sumTotalCost.toFixed(2),
                sumFinalTotal: sumFinalTotal.toFixed(2),
                sumOfAll: (sumTotalCost - sumFinalTotal).toFixed(2)
            };

            const recordID = await saveRecordToDB(record);
            record.id = recordID;
            addRecordToTable(record);
            
            // Try to save to Google Sheets, but don't block the local save if it fails
            try {
                await saveToGoogleSheets(record);
                showSuccess("Record saved successfully locally and to Google Sheets!");
            } catch (error) {
                console.error("Google Sheets error:", error);
                showSuccess("Record saved locally, but Google Sheets sync failed.");
            }

            // Reset the table to default empty state
            renderProductTable();
            document.getElementById("dailyTotal").innerText = "0.00";
        } catch (error) {
            console.error("Save error:", error);
            showError("Error saving record: " + error.message);
        }
    }

    function addRecordToTable(record) {
        const recordTable = document.getElementById("recordTable");
        const row = document.createElement("tr");
        row.setAttribute("data-id", record.id);

        // Limit display length for readability
        const displayProductNames = record.products.map(p => p.product).join(", ");
        const productText = displayProductNames.length > 50 
            ? displayProductNames.substring(0, 50) + "..." 
            : displayProductNames;

        row.innerHTML = `
            <td>${record.date}</td>
            <td title="${displayProductNames}">${productText}</td>
            <td>${record.products.map(p => p.price).join(", ")}</td>
            <td>${record.products.map(p => p.quantity).join(", ")}</td>
            <td>${record.products.map(p => p.totalCost).join(", ")}</td>
            <td>${record.products.map(p => p.part1).join(", ")}</td>
            <td>${record.products.map(p => p.part2).join(", ")}</td>
            <td>${record.products.map(p => p.finalTotal).join(", ")}</td>
            <td>${record.sumTotalCost}</td>
            <td>${record.sumFinalTotal}</td>
            <td>${record.sumOfAll}</td>
            <td>
                <button onclick="editRecord(this)">Edit</button>
                <button onclick="deleteRecord(this)">Delete</button>
            </td>
        `;
        recordTable.prepend(row); // Add most recent records at the top
    }

    function editRecord(button) {
        try {
            const row = button.parentElement.parentElement;
            const id = row.getAttribute("data-id");
            
            if (!id) {
                showError("Record ID not found.");
                return;
            }
            
            // Clear current inputs
            renderProductTable();
            
            // Get data from the row
            const cells = row.getElementsByTagName("td");
            
            const products = cells[1].getAttribute("title").split(", ");
            const prices = cells[2].innerText.split(", ").map(p => parseFloat(p) || 0);
            const quantities = cells[3].innerText.split(", ").map(q => parseFloat(q) || 0);
            const part1s = cells[5].innerText.split(", ").map(p => parseFloat(p) || 0);
            const part2s = cells[6].innerText.split(", ").map(p => parseFloat(p) || 0);
            
            // First, populate standard products
            let extraProductIndex = 0;
            
            for (let i = 0; i < products.length; i++) {
                const productName = products[i];
                const productIndex = this.products.findIndex(p => p.product === productName);
                
                if (productIndex !== -1) {
                    // This is a standard product
                    document.getElementById(`quantity-${productIndex}`).value = quantities[i] || 0;
                    document.getElementById(`part1-${productIndex}`).value = part1s[i] || 0;
                    document.getElementById(`part2-${productIndex}`).value = part2s[i] || 0;
                } else if (extraProductIndex < 10) {
                    // This is a custom product
                    document.getElementById(`product-extra-${extraProductIndex}`).value = productName;
                    document.getElementById(`price-extra-${extraProductIndex}`).value = prices[i] || 0;
                    document.getElementById(`quantity-extra-${extraProductIndex}`).value = quantities[i] || 0;
                    document.getElementById(`part1-extra-${extraProductIndex}`).value = part1s[i] || 0;
                    document.getElementById(`part2-extra-${extraProductIndex}`).value = part2s[i] || 0;
                    extraProductIndex++;
                }
            }
            
            // Update calculations
            updateDailyTotal();
            
            // Store record ID to later update it instead of creating a new one
            document.body.setAttribute("data-editing-id", id);
            
        } catch (error) {
            console.error("Edit error:", error);
            showError("Error editing record: " + error.message);
        }
    }

    async function deleteRecord(button) {
        try {
            const row = button.closest("tr");
            const id = row.getAttribute("data-id"); 
            
            if (!id) {
                showError("Record ID not found.");
                return;
            }

            // Ask for confirmation
            if (!confirm("Are you sure you want to delete this record?")) {
                return;
            }

            await deleteRecordFromDB(id);
            row.remove(); // Remove the row from the UI
            showSuccess("Record deleted successfully");
        } catch (error) {
            console.error("Delete error:", error);
            showError("Error deleting record: " + error.message);
        }
    }

    async function loadRecords() {
        try {
            const records = await loadRecordsFromDB();
            const recordTable = document.getElementById("recordTable");
            recordTable.innerHTML = ""; // Clear the table before loading records

            if (records.length === 0) {
                console.log("No records found in IndexedDB.");
            }

            // Sort records by date (newest first)
            records.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            records.forEach(record => {
                addRecordToTable(record);
            });
        } catch (error) {
            console.error("Load records error:", error);
            showError("Error loading records: " + error.message);
        }
    }

    function saveToGoogleSheets(record) {
        return new Promise((resolve, reject) => {
            fetch("https://script.google.com/macros/s/AKfycbyswxH2GJvLF0R1Jat-qVS3JTGRx6dWqfZk2lafh7F86knNgntZc_ILKawTdbK0HllE/exec", {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify(record),
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(response => {
                // With no-cors, we can't read the response
                // Just assume it worked if no error was thrown
                resolve("Success");
            })
            .catch(error => {
                console.error("Google Sheets Error:", error);
                reject(error);
            });
        });
    }

    // Initialize the application
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            await openDB();   // Ensure the database is open
            renderProductTable(); // Render product input fields
            await loadRecords();  // Load saved records
            showSuccess("Application loaded successfully");
        } catch (error) {
            console.error("Initialization error:", error);
            showError("Failed to initialize the application: " + error.message);
        }
    });
</script>
</body>
</html>
</script>
</body>
</html>
